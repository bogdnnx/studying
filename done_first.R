# 1. Загружаем необходимые пакеты
library(foreign)    # для чтения .sav файлов
library(ggplot2)    # для визуализации
library(vcd)        # для мозаичных графиков
library(dplyr)      # для манипуляций с данными

# 2. Загружаем файл с данными
base <- read.spss("docs/USATU/base.sav", to.data.frame = TRUE)
str(base)
# Возраст - q65
# Личный доход - q14_1
# Расходы на коммунальные платежи - q17_1
# Курение - q54
# Пол - q64
base1 <- base %>% 
  select(Возраст = q65, 
         Доход = q14_1, 
         Коммунальные = q17_1, 
         Курение = q54, 
         Пол = q64) %>%
  na.omit()  # Удаляем строки с пропущенными значениями

# 4. Описательная статистика
cat("\nОписательная статистика:\n")
summary(base1)

# 5. Таблица кросстабуляции Пол и Курение
cat("\nТаблица кросстабуляции Пол и Курение:\n")
(tab <- table(base1$Пол, base1$Курение))

# Тест хи-квадрат на независимость
cat("\nТест хи-квадрат на независимость Пола и Курения:\n")
chi_test <- chisq.test(tab)
print(chi_test)
#X-squared = 54.87, df = 3, p-value = 7.321e-12
#p.value< 0.05, отвергаем нулевую гипотезу о том, что курение и пол независмы -> зависимы

# 6. Мозаичный график
mosaic(~ Пол + Курение, data = base1,
       main = "Распределение курения по полу",
       labeling_args = list(set_varnames = c(Пол = "Пол респондента", 
                                             Курение = "Привычки курения")),
       highlighting = "Курение")

# 7. Средний доход по категориям курения
cat("\nСредний доход по категориям курения:\n")
income_by_smoking <- base1 %>%
  group_by(Курение) %>%
  summarise(Средний_доход = mean(Доход, na.rm = TRUE),
            Медианный_доход = median(Доход, na.rm = TRUE))
print(income_by_smoking)

# Проверка гипотезы о связи курения и дохода (ANOVA)
cat("\nРезультаты ANOVA для дохода по категориям курения:\n")
aov_result <- aov(Доход ~ Курение, data = base1)
summary(aov_result)
#Нулевая гипотеза Доход не зависит от курения (средние доходы одинаковы у всех категорий курильщиков).
#Альтернативная гипотезa: Доход зависит от курения 
#отвергаем нулевую гипотезу(доход не зависит от статуса курения)
#Привычки курения значимо влияют на доход





# 8. Ящики с усиками
ggplot(base1, aes(x = Курение, y = Доход, fill = Курение)) +
  geom_boxplot() +
  labs(title = "Распределение дохода по привычкам курения",
       x = "Привычки курения",
       y = "Личный доход") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# 9. Корреляционный анализ
quant_vars <- base1 %>% select(Возраст, Доход, Коммунальные)

# Матрица корреляций
cat("\nМатрица корреляций:\n")
(cor_matrix <- cor(quant_vars, method = "pearson"))
#Матрица показывает линейную зависимость между тремя количественными переменными:



# 2. Проверка значимости корреляций
ct_age_income <- cor.test(base1$Возраст, base1$Доход, method = "pearson")
print(ct_age_income)
#H0: коэффициент корреляции между возрастом и доходом равен нулю(связи нет)
#Нет значимых доказательств связи между возрастом и доходом (0.104  > 0.05).

ct_age_utilities <- cor.test(base1$Возраст, base1$Коммунальные, method = "pearson") 
print(ct_age_utilities)
#Коэффициент корреляции между Возрастом и Коммунальными платежами равен нулю.
#То есть, линейной связи нет.
#p-value = 0.0002 → меньше 0.05 → отвергаем нулевую гипотезу



ct_income_utilities <- cor.test(base1$Доход, base1$Коммунальные, method = "pearson")
print(ct_income_utilities)
#H0 Коэффициент корреляции между доходом и коммунальными платежами равен нулю → связи нет
#p-value = 0.00001439 → очень маленькое, отвергаем H₀


ggplot(base1, aes(x=Доход, y=Коммунальные)) + 
  geom_point(size=2)
